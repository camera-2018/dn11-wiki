# 子网并入

## 前言

将你的子网并入DN11意味着你的子网下的设备将直接被暴露在DN11中的

出于安全性考虑，在接入前，请检查你子网下的所有服务的使用权限，除非你有意公开这些服务，请确保他们有密码/秘钥等手段保护

由于目前DN11大部分节点都采用的openwrt，本教程基于openwrt编写，其他设备仅供参考

那么下面开始吧

## 检查硬件设备

检查你的网关设备是否支持WireGuard

::: tip
目前DN11仅支持通过WireGuard接入，后续会开放其他接入方式
:::

对于 openwrt 需要安装 `luci-app-wireguard` 包，使用web面板安装之后会连带一系列依赖。

之后请检查 `状态-WireGuard状态`是否存在，若不存在请考虑更换固件。具体更换什么固件可以向群友求助获得编译好的固件也可以自行编译。

::: details
x86 推荐使用 [immortalwrt](https://github.com/immortalwrt/immortalwrt)

其他架构可以考虑自行编译。
:::

## 申请网段

::: danger
建议大致浏览完 [bgp](/connect/bgp) 章节后再进行申请，能避免一些问题
:::

申请网段需要向 [dn11-registry](https://github.com/hdu-dn11/registry) 提交Pull Request

### 成员注册

您仅需要在 `as` 目录中创建一个 YAML 文件，文件名为 `<your-asn>.yml`，然后以 [`example.yml`](https://github.com/hdu-dn11/registry/blob/main/as/example.yml) 为模板填写。填写完成后提交一个 PR，根据 Checker 回复修改您的配置，然后等待管理员合并即可。

- `ASN`

  **必填**（文件名）

  格式为 `421111xxxx` 或 `422008xxxx` (仅 Vidar 成员)

  后四位任选，无冲突即可。

- `name`

  **必填**

  您的名字 / ID

- `contact`

  **必填** (为非个人注册时除外)

  联系方式，如 QQ / Email

  如使用 QQ 号等纯数字，请使用引号包裹，确保该项的值为字符串。

- `ip`

  **必填**，可多个

  您所使用的 IP 段

  DN11 默认从 `172.16.0.0/16` 段中使用 `/24` 作为成员段。请优先选择该段内的最小一个未使用的 `/24` 地址。

  您可在 [信息表](https://github.com/hdu-dn11/metadata/blob/main/README.md) 中查看已使用的 IP 段。

  如您确需使用其他 IP，请在群中说明情况。

- `domain`

  **选填**

  可在此处注册您的域名，以便我们为您生成 Zone 文件。

  如注册域名，则每个域名至少提供一个 NS 记录的 IP 地址。

- `ns`

  **选填**

  可在此处注册您的 NS 记录，以便我们为您生成 Zone 文件。

  每个 NS 记录对应一个 IP 地址。

  请注意，注册域名是不一定需要注册 NS 记录。如您使用其他成员提供的 NS 服务器，则无需注册 NS 记录。

- `comment`

  **选填**

  备注信息。会在信息表等场合展示。

- `monitor`

  **选填**。但若有，则至少包含下面任一项

  Monitor 额外配置项

  - `appendix`

    附加信息，会在 Monitor 中展示

  - `custom`

    自定义 ECharts 效果。参考 [此处](https://echarts.apache.org/zh/option.html#series-graph.data)

    JSON 格式

## 设备切换网段

你需要将你设备的网段切换到申请到的网段

::: danger
如果你是新手，更建议全部推倒重新配置

如果确定要切换，请务必在大佬指导下操作，不然容易**寄**
:::

由于不同的人有不同网络环境，比较复杂，这里仅简单描述

### 修改静态IP设备的IP

将除主路由外的所有需要静态IP地址的设备的IP修改到新网段

修改完成后这些设备将无法访问，但这是暂时的，无须担心

::: tip
如果使用了旁路由，请先将网关临时改回主路由，暂时停用旁路由，将旁路由作为一个普通的静态ip分配设备操作
:::

### 修改主路由IP与DHCP

修改主路由IP与DHCP，openwrt主路由的请修改lan口相关配置

#### 网段划分建议

- 静态IP池：172.16.X.0/26  `即172.16.X.2~172.16.X.63`
- DHCP池：172.16.X.64/26   `即172.16.X.64~172.16.X.127`
- 外部IP池：172.16.X.128/26  `即172.16.X.128~172.16.X.191`
- 备用：172.16.X.192/26     `即172.16.X.192~172.16.X.253`

当然你也可以用自己喜欢的方式划分网段，毕竟这是你自己的网络

分配IP时，不要占用.255和.0，.254也不要占用（可能会成为你后续配置的wg隧道地址）

#### 配置建议

- IP：`172.16.X.1`
- 子网掩码：`255.255.255.0`
- DHCP池（建议）：172.16.X.64/26

## 生成密钥对

在安装有WireGuard的设备上输入以下指令生成一个秘钥

`wg genkey`

可以使用openwrt的shell

该命令会输出一串base64字符串，这就是你的**私钥（privatekey）**，请复制并妥善保管

## 添加接口并配置防火墙

::: danger

下面的内容对于现在的dn11已经过期，但是可以作为单点接入自己的参考。

更多内容推荐移步[BGP组网](/connect/bgp)章节

:::

### 创建并配置接口

在 `网络-接口-添加新接口...`里创建新接口

- 名称（）：`dn11`
- 新接口协议：`WireGuard VPN`

完成创建后，点击 `修改`，修改你新建的接口，在基本设置中填入

- 私钥：填入你在上一步生成的私钥
- 监听端口：随意，不建议用过低的端口和特殊端口
- IP地址：该设备地址，一般填入 `172.16.X.1/24`

然后在防火墙设置（在接口的基本设置右边）中选择不指定或新建，右边填入DN11，这一步将新建一个名为DN11的新防火墙区域

### 配置防火墙区域

在 `网络-防火墙-区域` ，点击DN11的修改，对DN11区域进行修改

- 入站数据：接受
- 出站数据：接受
- 转发：接受
- 允许转发到：lan，wan
- 允许从源区域转发：lan，wan

> 如果你在配置旁路由，没有wan

### 打开端口

点击 `防火墙-通信规则-打开路由器接口-添加`

- 名称（建议）：dn11
- 传输协议：udp
- 源区域：任意区域
- 源MAC地址：所有
- 源地址：所有
- 源端口：所有
- 目标区域：设备（输入）
- 目标地址：所有
- 目标端口：填写你配置接口使用的监听端口
- 动作：接受

这一步打开端口给所有地址连接

### 测试连接

现在你可以试着用你的设备来连接openwrt上的WireGuard了
